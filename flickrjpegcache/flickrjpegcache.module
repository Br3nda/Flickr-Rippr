<?php

/**
 * 
 */
function flickrjpegcache_flickrrippr_path_options() {
  return array('flickrjpegcache' => 'Local Jpeg Cache');
}

/**
 * implementatin of hook_flickrrippr_path
 * Save the file on the file system - not as a deep linking src to flickr.com
 */
function flickrjpegcache_get_path($flickr_photo, $size=FALSE, $refetch=FALSE) {
  $filename = $flickr_photo['flickrphoto_id'] .'_'. $flickr_photo['secret'] . ($size ? '_'. $size : '') .'.jpg';

//   drupal_set_message(file_directory_path() .DIRECTORY_SEPARATOR . $filename);
  if(!$refetch && file_exists(file_directory_path() . DIRECTORY_SEPARATOR. $filename)) {
    return file_directory_path() . DIRECTORY_SEPARATOR. $filename;
  }

  $src = flickrrippr_path_remote($flickr_photo, $size);
  $response = drupal_http_request($src);
  if ($response->code != 200) {
    drupal_set_message(t('Failed to fetch jpeg from flickr'), 'error');
    return $src;
  }

  
  //jpeg is now in $response->data
  $file = file_save_data($response->data, $filename, FILE_EXISTS_REPLACE);
//   drupal_set_message(t("Jpeg saved locally as %file", array('%file' => $file)));
  return $file;
}