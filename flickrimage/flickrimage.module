<?php

/**
 *
 */
function flickrimage_flickrrippr_node_handler_options() {
  return array('flickrimage' => 'Image Module');
}

/**
 * Implementation of hook_flickrrippr_node_save_handler().
 * Save the file on the file system - not as a deep linking src to flickr.com
 */
function flickrimage_flickrrippr_node_save_handler($details) {

  
  $nid = flickrrippr_photo_get_nid($details['photo_id']);
  drupal_set_message(__FUNCTION__);


    //get original jpeg
  $src = flickrrippr_path_remote($details['info'], 'o');
  drupal_set_message("Src = $src");
  $response = drupal_http_request($src);
  if ($response->code != 200) {
    drupal_set_message(t('Failed to fetch jpeg from flickr. URL was %url', array('%url' => $src)), 'error');
    return;
  }

  drupal_set_message(__FUNCTION__);
  return;

  if ($nid) {
    drupal_set_message("Existing node = $nid");
    $node = node_load(array('nid' => $nid));
    $node->type = 'image';
    return $node;
//     node_save($node);
  }
  else {



    $filename = $flickr_photo['id'] .'_'. $flickr_photo['secret'] . '_o.jpg';
    //jpeg is now in $response->data
    $file = file_save_data($response->data, $filename, FILE_EXISTS_REPLACE);

    if (!$file) {
      drupal_set_message(t('Failed to save file %filename', array('%filename' => $filename)), 'error');
      watchdog('flickrimage', t('Failed to save file %filename', array('%filename' => $filename)));
      return flickrrippr_path_remote($flickr_photo, $size);
    }

    drupal_set_message(t("Saving new image node."));
  //function image_create_node_from($filepath, $title = NULL, $body = '', $taxonomy = NULL) {
    $image_node = image_create_node_from($file, $flickr_photo['title'], $flickr_photo['description']);
    if (!$image_node) {
      drupal_set_message(t('Failed to save as an image node.'), 'error');
      return flickrrippr_path_remote($flickr_photo, $size);
    }
    return $image_node;
  }
}
